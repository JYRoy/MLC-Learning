# Triton Optimization

- [Triton Optimization](#triton-optimization)
  - [Overview](#overview)
  - [TritonGPU Dialect](#tritongpu-dialect)
  - [References](#references)

## Overview

Triton的optimizer可以分为三个部分：

1. Triton IR优化
2. Triton IR到TritonGPU IR转换
3. TritonGPU IR优化

![triton optimizer workflow](../.images/triton%20optimizer%20workflow.png)

Triton中的所有passes都在python/src/passes.cc中被注册到libtriton.passes的module中

- passes：TritonIR、TritonGPUIR和LLVMIR依赖的所有passes
  - analysis
    - ModuleAllocation
    - ModuleMembarAnalysis
  - common
    - SCCP
    - SymbolDCE
    - Inliner：将Kernel Call的子函数inline展开
    - Canonicalizer：一些简化的pattern rewrite
    - CSE：MLIR的cse pass，用于公共子表达式消除
    - LoopInvariantCodeMotion：MLIR的pass，将循环无关的变量挪到forloop外面
  - convert
    - ConvertSCFToCF
    - ConvertControlFlowToLLVM
    - CovertIndexToLLVM
    - ArithToLLVMConversion
  - ttir
    - CombineOps：一些特定的pattern rewrite
    - ReorderBroadcast
    - RewriteTensorPointer
    - ConvertTensorPointer
    - ConvertTritonToTritonGPU：将TritonIR转换为TritonGPU IR，主要是增加TritonGPU特有的layout
  - ttgpuir
    - TritonGPUCoalesce：针对load和store修改layout，重拍order，使得最大contiguity的维度排在最前面，合并全局访存
    - TritonGPUOptimizeThreadLocality
    - TritonGPUPipeline：数据预取，MMA指令对应的global memory到shared memory的N-buffer优化
    - TritonGPUPrefetch：SMEM到Regs，MMA指令对应的shared memory到register file的N-buffer优化
    - TritonGPUAccelerateMatMul：修改layout以使用tensor core，软流水，back conflict去除
    - TritonGPUReorderInstructions：
    - TritonGPUF32DotTC
    - TritonGPUOptimizerDotOperands
    - TritonGPURemoveLaytoutConversions：沿着数据流传播layout，消除不必要的layout转换
    - TritonGPUReduceDataDuplication
    - AllocateSharedMemory
    - TritonGPUCombineTensorSelectAndIf
    - ConvertTritonGPUToLLVM：生成SIMT的LLVMIR。添加shared memroy和barrier。
    - DecomposeUnsupportedConversions
  - ttnvgpuir
    - TritonNvidiaGPUPlanCTA
    - TritonNvidiaGPUFenceInsertion
    - TritonNvidiaGPUTMALowering
  - llvmir
    - LLVMDIScope

从功能上划分，有些pass是优化IR的，有些pass是转换IR的。

有些是Triton中实现的，有些是MLIR中原本就存在的。

## TritonGPU Dialect




## References

- [MLIR 之 Dialect Conversion](https://tpumlir.org/zh-cn/2022/11/18/mlir-zhi-dialect-conversion.html)
- [Triton-MLIR: 从DSL到PTX](https://zhuanlan.zhihu.com/p/671434808)
- [OpenAI Triton: Memory Coalesce](https://zhuanlan.zhihu.com/p/670141785)
- [CUDA编程学习笔记-03(内存访问)](https://zhuanlan.zhihu.com/p/632244210)
- [OpenAI Triton: Dive into Axis and Coalesce](https://zhuanlan.zhihu.com/p/687394750)
- [OpenAI/Triton MLIR 迁移工作简介](https://superjomn.github.io/posts/triton-mlir-publish/)